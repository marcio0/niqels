/*! expenses 2013-09-06 */
"use strict";function BalancePanelCtrl(a,b,c,d,e,f){a.updateBalance=function(){var b,d,e,g=moment();b=g,c.month!=g.month()&&(b.month(c.month),b=b.endOf("month")),d=[b];for(var h=0;2>h;h++){var i=d[h].clone().subtract("month",1);d.push(i)}d.reverse();for(var h in d)d[h]=d[h].format("YYYY-MM");e=d[d.length-1],d=angular.toJson(d);var j={months:d,up_to_day:b.date()};a.chartData=f.fetchData(j).then(function(c){var d=c.options,f=c.result;return a.income=parseFloat(f.data[e].income),a.outgo=parseFloat(f.data[e].outgo),d.subtitle={text:gettext("Data up to day %s.").replace("%s",b.date())},c.options})},c.$on("transactionCreated",a.updateBalance),c.$on("transactionRemoved",a.updateBalance),c.$watch("month",a.updateBalance)}function CategoryEditCtrl(a){a.removeCategory=function(b){b.$delete(),this.hide(),a.$emit("categoryRemoved",b),a.loadCategories()},a.saveCategory=function(){var a=this,b=this.editing_category.id?"$update":"$save";this.category_form.$valid?this.editing_category[b](function(c){a.hide();var d="$save"==b?"categoryCreated":"categoryUpdated";a.$emit(d,c),a.loadCategories()}):toastr.warning(gettext("Please fill in the fields correctly."))}}function CategoryListCtrl(a,b,c,d){a.loadCategories=function(){b.query().$then(function(b){var c=b.resource;a.categories=c})},a.createCategory=function(){a.editCategory(new b)},a.editCategory=function(a){var e=this.$new();e.editing_category=new b(a);var f=c({template:"category-edit.html",persist:"false",show:!1,backdrop:!0,scope:e});d.when(f).then(function(a){a.modal("show")})},a.loadCategories()}function ReminderListCtrl(a,b){b.query().$then(function(b){var c=b.resource;a.reminders=c})}function RemindersCtrl(a,b,c){function d(){var b=moment().add("days",5).format("YYYY-MM-DD"),d={due_date__lte:b};c.query(d).$then(function(b){a.reminders=b.resource})}a.reminders=[],b.$on("reminderCreated",d),a.createTransaction=function(a){a.createTransaction().then(function(a){b.$emit("transactionCreated",a),d()})},a.skip=function(a){a.skip(),d()},d()}function TransactionActionBarCtrl(a,b,c){a.removeTransaction=function(){b.delete({id:a.transaction.id}).$then(function(){for(var b in a.days){var d=a.days[b];d.day===a.transaction.date&&(d.transactions.splice(d.transactions.indexOf(a.transaction),1),0==d.transactions.length&&a.days.splice(a.days.indexOf(d),1))}c.$emit("transactionRemoved",a.transaction)})}}function TransactionFormCtrl(a,b,c,d,e,f){a.repeatOptions=["daily","weekly","biweekly","monthly"];var g=function(){a.formData={repeat:"monthly"},a.sending=!1,a.isRepeat=!1};g(),a.submit=function(){var b=a.formData,c=this.transactionForm;if(c.$valid){a.sending=!0;var h=null;if(a.isRepeat){b.due_date=b.date;var i=new f(b);h=i.createReminder().then(function(a){return g(),a}).then(function(a){return d.$emit("reminderCreated",a.resource),a}),a.isRepeat=!1}else h=e.save(b).$then(function(a){return g(),a}).then(function(a){return d.$emit("transactionCreated",a.resource),a});h.always(function(){c.$setPristine(),a.sending=!1})}else c.category.$dirty=!0,toastr.warning(gettext("Please fill in the fields correctly."))}}function TransactionListCtrl(a,b,c){a.days=[],b.month=moment().month(),b.filterDate=new Date,a.loading=!0;var d=function(b){var d,e,f;a.loading=!0,d=b.startOf("month"),e=moment(d).endOf("month"),f={date__gte:d.format("YYYY-MM-D"),date__lte:e.format("YYYY-MM-D"),limit:0},c.query(f).$then(function(b){a.days=[];for(var c=b.resource,d={},e=0;e<c.length;e++){var f=c[e];f.date in d||(d[f.date]=[]),d[f.date].push(f)}for(var g in d)a.days.push({day:g,transactions:d[g]})}).always(function(){a.loading=!1})};a.$watch("filterDate",function(a){var c=moment(a);b.month=c.month(),d(c)}),a.moveMonth=function(b){a.filterDate=moment(a.filterDate)[b]("month",1).toDate()},b.$on("transactionCreated",function(c,d){var e=b.month+1,f=parseInt(d.date.split("-")[1]);if(e===f){for(var g in a.days){var h=a.days[g];if(h.day==d.date)return h.transactions.unshift(d),void 0}a.days.push({day:d.date,transactions:[d]})}}),a.isEmpty=function(){return 0==a.days.length&&!a.loading}}var app=angular.module("webapp",["models","interceptor","$strap.directives","ui.state","charts"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/transactions"),a.state("transactions",{url:"/transactions",templateUrl:"transaction-list.html"}).state("settings",{url:"/settings",templateUrl:"settings.html"}).state("settings.categories",{url:"/categories",templateUrl:"/partials/category-list/",controller:"CategoryListCtrl"}).state("settings.reminders",{url:"/reminders",templateUrl:"/partials/reminder-list/",controller:"ReminderListCtrl"})}]).config(["$httpProvider",function(a){a.defaults.headers.common["X-CSRFToken"]=$("body > input[name=csrfmiddlewaretoken]").val(),a.responseInterceptors.push("sessionInterceptor")}]).config(["$interpolateProvider",function(a){a.startSymbol("(("),a.endSymbol("))")}]).run(["$locale",function(a){moment().lang(a.id)}]).run(["$rootScope","$state","$window",function(a,b){a.$on("transactionCreated",function(a,b){-1==user_categories.indexOf(b.category.name)&&user_categories.push(b.category.name)}),a.gettext=function(a){return gettext(a)},a.interpolate=function(a,b,c){return interpolate(a,b,c)},a.$state=b,toastr.options={positionClass:"toast-bottom-right",fadeIn:400,fadeOut:500,timeOut:3e3,extendedTimeOut:3e3},toastr.notifyCreationSuccess=function(a){toastr.success(gettext("%s sucessfuly created!").replace("%s",a))},toastr.notifyUpdateSuccess=function(a){toastr.success(gettext("%s sucessfuly updated!").replace("%s",a))},toastr.notifyCreationFailure=function(a){toastr.error(gettext("An error ocurred creating %s.").replace("%s",a.toLowerCase()))},toastr.notifyRemovalSuccess=function(a){toastr.success(gettext("%s sucessfuly removed.").replace("%s",a))}}]);angular.module("webapp").directive("colorpicker",["$parse",function(a){return{require:"ngModel",restrict:"A",link:function(b,c,d){c.spectrum({showInitial:!0,showPalette:!0,showPaletteOnly:!0,preferredFormat:"hex",change:function(c){b.$apply(function(){var e=a(d.ngModel);e.assign(b,c.toHexString())})},palette:[["rgb(0, 0, 0)","rgb(67, 67, 67)","rgb(102, 102, 102)","rgb(204, 204, 204)","rgb(217, 217, 217)","rgb(255, 255, 255)"],["rgb(152, 0, 0)","rgb(255, 0, 0)","rgb(255, 153, 0)","rgb(255, 255, 0)","rgb(0, 255, 0)","rgb(0, 255, 255)","rgb(74, 134, 232)","rgb(0, 0, 255)","rgb(153, 0, 255)","rgb(255, 0, 255)"],["rgb(230, 184, 175)","rgb(244, 204, 204)","rgb(252, 229, 205)","rgb(255, 242, 204)","rgb(217, 234, 211)","rgb(208, 224, 227)","rgb(201, 218, 248)","rgb(207, 226, 243)","rgb(217, 210, 233)","rgb(234, 209, 220)","rgb(221, 126, 107)","rgb(234, 153, 153)","rgb(249, 203, 156)","rgb(255, 229, 153)","rgb(182, 215, 168)","rgb(162, 196, 201)","rgb(164, 194, 244)","rgb(159, 197, 232)","rgb(180, 167, 214)","rgb(213, 166, 189)","rgb(204, 65, 37)","rgb(224, 102, 102)","rgb(246, 178, 107)","rgb(255, 217, 102)","rgb(147, 196, 125)","rgb(118, 165, 175)","rgb(109, 158, 235)","rgb(111, 168, 220)","rgb(142, 124, 195)","rgb(194, 123, 160)","rgb(166, 28, 0)","rgb(204, 0, 0)","rgb(230, 145, 56)","rgb(241, 194, 50)","rgb(106, 168, 79)","rgb(69, 129, 142)","rgb(60, 120, 216)","rgb(61, 133, 198)","rgb(103, 78, 167)","rgb(166, 77, 121)","rgb(91, 15, 0)","rgb(102, 0, 0)","rgb(120, 63, 4)","rgb(127, 96, 0)","rgb(39, 78, 19)","rgb(12, 52, 61)","rgb(28, 69, 135)","rgb(7, 55, 99)","rgb(32, 18, 77)","rgb(76, 17, 48)"]]}),b.$watch(d.ngModel,function(a){c.spectrum("set",a)})}}}]).directive("exMonthSelector",["$locale",function(a){return{scope:{date:"=exMonthSelector"},link:function(b,c){var d=function(a){var b=moment(a).format("MMMM - YYYY");c.text(b)},e=function(a){d(a),c.data("datepicker").update(a)};b.$watch("date",e);var f=function(a){d(a.date);var e=c.data("datepicker");e.hide(),b.$apply(function(){b.date=a.date})};c.datepicker({format:"dd-mm-yyyy",language:a.id,keyboardNavigation:!1,startView:1,minViewMode:1,todayBtn:"linked",todayHighlight:!0}).on("changeDate",f)}}}]).directive("exCurrency",["$filter",function(a){return{replace:!0,template:'<span class="text-((color))" ng-bind="value"></span>',scope:{rawValue:"=exCurrencyValue"},link:function(b){b.$watch("rawValue",function(){b.value=a("currency")(b.rawValue),b.color=b.rawValue<0?"error":b.rawValue>0?"success":""})}}}]).directive("exDeviation",["$filter",function(a){return{replace:!0,template:'<span class="text-((color))" >((value))% <i class="((icon)) icon-large"></i></span>',scope:{rawValue:"@exDeviationValue"},link:function(b){b.$watch("rawValue",function(c){b.value=a("number")(100*b.rawValue,2),0==c?b.color="":c>0?(b.color="success",b.icon="icon-caret-up"):0>c&&(b.color="error",b.icon="icon-caret-down")})}}}]).directive("confirmationNeeded",function(){return{priority:1,link:function(a,b,c){var d=c.confirmationNeeded||gettext("Confirm action"),e=c.ngClick;delete c.ngClick,b.bind("click",function(){a.$apply(function(){window.confirm(d)&&a.$eval(e)})})}}}).directive("exCategory",function(){return{restrict:"A",scope:{category:"=exCategory"},replace:!0,template:'<span class="category-label" ng-bind="category.name" ng-style="{backgroundColor: category.color}"></span>'}}).directive("exCategoryfield",["Category","$rootScope","$cacheFactory",function(a){return{require:"?ngModel",restrict:"A",link:function(b,c,d,e){a.query().$then(function(a){c.data("typeahead").source=a.resource}),c.typeahead({items:3,matcher:function(a){return $.fn.typeahead.Constructor.prototype.matcher.call(this,a.name)},sorter:function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c].name);return $.fn.typeahead.Constructor.prototype.sorter.apply(this,[b])},updater:function(a){return a},highlighter:function(a){return a}}),c.bind("change",function(){b.$apply(function(){return e.$setViewValue(c.val())})})}}}]).directive("exActionbar",function(){return{restrict:"A",link:function(a,b){b.parent().hover(function(){$(this).addClass("tr-hover")},function(){$(this).removeClass("tr-hover")})}}}).directive("exDatepicker",["$locale",function(a){return{restrict:"A",scope:{date:"=exDatepicker"},link:function(b,c){var d=function(a){b.$apply(function(){b.date=moment(a.date).format("DD/MM/YYYY")})};c.datepicker({language:a.id,format:"yyyy-mm-dd",keyboardNavigation:!1,todayHighlight:!0,todayBtn:"linked"}).on("changeDate",d),b.$watch("date",function(a){if(void 0==a){var d=moment().format("YYYY-MM-DD");c.data("datepicker").update(d),b.date=d}})}}}]).directive("exValuefield",function(){return{require:"?ngModel",restrict:"A",link:function(a,b,c,d){var e=function(){return a.$apply(function(){return d.$setViewValue(b.val())})};b.maskMoney({allowNegative:!0,allowZero:!0,thousands:".",decimal:",",negativeDefault:!0}),b.keyup(function(){var a=$(this),b=a.siblings("span.add-on"),c="";if(e(),"-"===a.val().charAt(0))c="#b94a48";else if(parseInt(a.val().charAt(0)))c="#b94a48";else{if("+"!==a.val().charAt(0))return;c="#468847"}a.css("color",c),b.css("color",c)})}}}),angular.module("webapp").factory("calculators",function(){return{deviation:function(){}}}),angular.module("interceptor",[]).factory("sessionInterceptor",["$q","$window",function(a,b){return function(c){return c.then(null,function(c){return 401===c.status&&(b.location.href="/login"),a.reject(c)})}}]),BalancePanelCtrl.$inject=["$scope","$http","$rootScope","$filter","calculators","BalanceChart"],CategoryEditCtrl.$inject=["$scope"],CategoryListCtrl.$inject=["$scope","Category","$modal","$q"],ReminderListCtrl.$inject=["$scope","Reminder"],RemindersCtrl.$inject=["$scope","$rootScope","Reminder","$filter"],TransactionActionBarCtrl.$inject=["$scope","Transaction","$rootScope"],TransactionFormCtrl.$inject=["$scope","$element","$http","$rootScope","Transaction","Reminder"],TransactionListCtrl.$inject=["$scope","$rootScope","Transaction","$filter"],angular.module("charts",[]).factory("BalanceChart",["$http","$filter","$q",function(a,b,c){return{fetchData:function(d){var e=this,f=c.defer();return a.get("/api/v1/data/balance/",{params:d}).then(function(a){var c=[],d=[],g={},h=0;$.extend(!0,g,e.chartOptions);for(var i in a.data){var j,k={};j=moment(i,"YYYY-MM").format("MMM YYYY"),c.push(j),k.income=parseFloat(a.data[i].income),k.income_text=b("currency")(k.income),k.outgo=parseFloat(a.data[i].outgo),k.outgo_text=b("currency")(k.outgo),k.y=k.income+k.outgo,k.y_text=b("currency")(k.y),k.color=k.y<0?"#9d261d":"#049cdb",k.id=i,d.push(k),h+=k.y}h/=d.length,g.xAxis.categories=c,g.yAxis.plotLines.push({value:h,color:"red",width:1,zIndex:4,label:{align:"right",text:b("currency")(h)}}),g.series=[{data:d}],f.resolve({options:g,result:a})},function(a){f.reject(a)}),f.promise},chartOptions:{chart:{type:"column",spacingLeft:3,spacingRight:3},title:{text:null},xAxis:{},legend:{enabled:!1},yAxis:{title:null,plotLines:[{value:0,color:"#000",width:1,zIndex:4}]},tooltip:{headerFormat:'<div class="title">{point.key}</div>',pointFormat:'<p class="income">Income: <b>{point.income_text}</b></p><p class="outgo">Outgo: <b>{point.outgo_text}</b></p><p class="total">Total: <b>{point.y_text}</b></p>',borderRadius:0,shared:!0,animation:!1,useHTML:!0,positioner:function(){return{x:0,y:0}}},plotOptions:{column:{pointPadding:.2,borderWidth:0}}}}}]).directive("chart",[function(){return{restrict:"A",template:"<div></div>",scope:{chartData:"=value"},transclude:!0,replace:!0,link:function(a,b,c){var d={chart:{renderTo:b[0],type:c.type||null,height:c.height||null,width:c.width||null}};a.$watch("chartData",function(b){if(b){var c=!0,e={};$.extend(c,e,d,a.chartData),new Highcharts.Chart(e)}})}}}]);var tastypieDataTransformer=function(a){return a.defaults.transformResponse.concat([function(a){if(a.meta&&a.objects){var b=a.objects;return b.meta=a.meta,b}return a}])};angular.module("models",["ngResource"]).factory("Reminder",["$resource","$http","Transaction","$q","$rootScope",function(a,b,c,d,e){var f=a("/api/v1/reminder/:id",{id:"@id"},{query:{method:"GET",isArray:!0,transformResponse:tastypieDataTransformer(b)}});return f.prototype.remainingDays=function(){var a=moment(this.due_date);return a.fromNow()},f.prototype.createReminder=function(){var a=d.defer();return this.$save({},function(b){var c=b.createTransaction().then(function(a){return e.$broadcast("transactionCreated",a,{silent:!0}),b});a.resolve(c)},function(b){a.reject(b)}),a.promise},f.prototype.skip=function(){return b.post(this.resource_uri+"/skip",{})},f.prototype.createTransaction=function(){var a=d.defer();return b.post(this.resource_uri+"/transaction",{}).success(function(b){a.resolve(new c(b))}).error(function(b){a.reject(b)}),a.promise},e.$on("reminderCreated",function(a,b,c){c=c||{},c&&!c.silent&&toastr.notifyCreationSuccess(gettext("Reminder"))}),f}]).factory("Transaction",["$resource","$http","$rootScope",function(a,b,c){var d=a("/api/v1/transaction/:id",{},{query:{method:"GET",isArray:!0,transformResponse:tastypieDataTransformer(b)}});return c.$on("transactionCreated",function(a,b,c){c=c||{},c&&!c.silent&&toastr.notifyCreationSuccess(gettext("Transaction"))}),d}]).factory("Category",["$resource","$cacheFactory","$http","$rootScope",function(a,b,c,d){var e=b("Category"),f=a("/api/v1/category/:id",{id:"@id",limit:100},{query:{method:"GET",isArray:!0,cache:e,transformResponse:tastypieDataTransformer(c)},update:{method:"PUT"}});return d.$on("categoryUpdated",function(a,b,c){c=c||{},c&&!c.silent&&toastr.notifyUpdateSuccess(gettext("Category")),e.remove("/api/v1/category?limit=100")}),d.$on("categoryCreated",function(a,b,c){c=c||{},c&&!c.silent&&toastr.notifyCreationSuccess(gettext("Category")),console.log("removendo"),e.remove("/api/v1/category?limit=100")}),d.$on("categoryRemoved",function(a,b,c){c=c||{},c&&!c.silent&&toastr.notifyRemovalSuccess(gettext("Category")),e.remove("/api/v1/category?limit=100")}),d.$on("transactionCreated",function(a,c){console.log("recarregando cache");var d=b.get("Category"),e=d.get("/api/v1/category?limit=100"),f=c.category.id;-1==e.indexOf('"id": %d,'.replace("%d",f))}),f}]);